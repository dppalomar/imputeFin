---
title: "Imputation of Financial Time Series"
author: |
  | Junyan Liu and Daniel P. Palomar
  | The Hong Kong University of Science and Technology (HKUST)
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: vignette
    toc: yes
    toc_depth: 2
csl: ieee.csl
bibliography: refs.bib
vignette: |
  %\VignetteIndexEntry{Imputation of Financial Time Series}
  %\VignetteKeyword{imputation, time series, missing values, AR, random walk, econometrics}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, echo = FALSE}
library(knitr)
opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.align = "center",
  fig.retina = 2,
  out.width = "85%",
  dpi = 96,
  pngquant = "--speed=1"
)
knit_hooks$set(pngquant = hook_pngquant)
# rmarkdown::render("vignettes/ImputeFinancialTimeSeries.Rmd", "prettydoc::html_pretty")
```

-----------
> This vignette illustrates the usage of the package [`imputeFin`](https://CRAN.R-project.org/package=imputeFin) 
for imputation of missing values in time series that fit a random walk or an autoregressive (AR)
model. As a side result, the parameters of the model are estimated from the incomplete time series.


# Installation
The package can be installed from [CRAN](https://CRAN.R-project.org/package=imputeFin) or [GitHub](https://github.com/dppalomar/imputeFin):
```{r, eval=FALSE}
# install stable version from CRAN
install.packages("imputeFin")

# install development version from GitHub
devtools::install_github("dppalomar/imputeFin")

# Getting help
library(imputeFin)
help(package = "imputeFin")
?imputeAR1Gaussian
```


# Usage of the package
This package can be used to impute missing values in time series that fit AR(1) model. Besides, it can also be used to estimate the model parameters of AR(1) model from incomplete time serie with missing values.


## Dataset
To use this package, the time series objects with missing values should be coercible to either a numeric vector or numeric matrix (e.g., zoo or xts) with missing values denoted by NA. For convienience of illustration and testing purposes, we provide two zoo time series objects with missing values in the package. One of the time series objects is generated from an AR(1) model with Gaussian distributed innovations. The generated incomplete time series object with missing values, together with the model parameters, are stored in `ts_AR1_Gaussian`. The other time series object is generated from an AR(1) model with Student's t distributed innovations. The generated time series object and model parameters are stored in `ts_AR1_t`. These data can be loaded as follows:
```{r, message = FALSE}
library(imputeFin)
data(ts_AR1_Gaussian) 
data(ts_AR1_t) 
```

## Parameter estimation of Gaussian AR(1) model
In this part, we show how to use the function `estimateAR1Gaussian()` to estimate the parameters of the Gaussian AR(1) model from incomplete time series with missing values. 

We start with univariate Gaussian AR(1) time series. In the following example, we first load package and a univariate Gaussian AR(1) time series object with missing values.  Then we use the function `estimateAR1Gaussian()` to estimate the parameters of Gaussian AR(1) model. The function returns a list consisting of the estimated values of the parameters.

```{r, message = FALSE}
library(imputeFin)
data(ts_AR1_Gaussian)
y_missing <- ts_AR1_Gaussian$y_missing[,2]
estimation_result <- estimateAR1Gaussian(y_missing)
estimation_result$phi0
estimation_result$phi1
estimation_result$sigma2
```
If you know that the time series is from a random walk model, which means that the `phi1 = 1`, then you can set the argument `random_walk = TRUE` (it is `FALSE` by default). Or if the time series is from a Gaussian AR(1) model with zero mean, then you should set the argument `zero_mean = TRUE` (it is `FALSE` by default).

```{r, message = FALSE}
estimation_result <- estimateAR1Gaussian(y_missing, random_walk = TRUE)
estimation_result$phi0
estimation_result$phi1
estimation_result$sigma2
```

For multiple time series, the function `estimateAR1Gaussian()` can be used in the same way. In the following example, the object `y_missing` contains three different time series: 'a', 'b', and 'c'. The function `estimateAR1Gaussian()` estimates model parameters for each time series separately. The returned value is a list consisting of the estimation results for each time series and additional elements that combine the estimated values in a convenient vector form.

```{r, message = FALSE}
y_missing <- ts_AR1_Gaussian$y_missing
estimation_result <- estimateAR1Gaussian(y_missing)
estimation_result$a
estimation_result$b
estimation_result$c
estimation_result$phi0_vct
estimation_result$phi1_vct
estimation_result$sigma2_vct
```

## Parameter estimation of Student's t AR(1) model
The function `estimateAR1t()` can be used to estimate the parameters of the Student's t AR(1) model from incomplete time series with missing values. Its usage is similar to the usage of `estimateAR1Gaussian()`. When using `estimateAR1t()`, there is an argument `fast_and_heuristic`, which indicates whether a heuristic but fast method is to be used to estimate the parameters. By default, it is `TRUE`.
```{r, message = FALSE}
library(imputeFin)
data(ts_AR1_t)
y_missing <- ts_AR1_t$y_missing
estimation_result <- estimateAR1t(y_missing)
estimation_result$a
estimation_result$b
estimation_result$c
estimation_result$phi0_vct
estimation_result$phi1_vct
estimation_result$sigma2_vct
estimation_result$nu_vct
```


## Imputation of missing values based on Gaussian AR(1) model
In this part, we show how to use the function `imputeAR1Gaussian()` to impute the missing values in time series based on Gaussian AR(1) model. First, we load package and a Gaussian AR(1) time series object with missing values. Then we use the function `imputeAR1Gaussian()` to impute the missing values. Finally, we use the function `plotImputed` to plot the imputed time series. 

              
```{r, message = FALSE}
library(imputeFin)
data(ts_AR1_Gaussian)
y_missing <- ts_AR1_Gaussian$y_missing
y_imputed <- imputeAR1Gaussian(y_missing)
plotImputed(y_imputed, column = 1, type = "ggplot2")
```


The function `imputeAR1Gaussian()`  first estimate the model parameters of Gaussian AR(1) model from the input incomplete time series with missing values, and then impute missing values of time series by drawing samples from the conditional distribution of the missing values given the observed data based on the estimated Gaussian AR(1) model. By default, the number of imputations is 1 (`n_samples = 1`), and the function `imputeAR1Gaussian()` return an imputed time series of the same class and dimensions with the input `y_missing` with one new attribute recording the locations of missing values (the function `plotImputed()` make use of such information to indicate the imputed values).

If you want multiple imputations, for example, three imputations, you can set the argument `n_samples = 3`. Then the function will return a list consisting of three imputed time series with names: y_imputed.1, y_imputed.2, and y_imputed.3 

```{r, message = FALSE}
imputation_result <- imputeAR1Gaussian(y_missing, n_samples = 3)
y_imputed1 = imputation_result$y_imputed.1
y_imputed2 = imputation_result$y_imputed.2
y_imputed3 = imputation_result$y_imputed.3
```

In addition to the imputed time series, the function can return the estimated parameters of Gaussian AR(1) model if you set the argument `return_estimates = TRUE` (by default, it is `FALSE`).

```{r, message = FALSE}
imputation_result <- imputeAR1Gaussian(y_missing, n_samples = 3, return_estimates = TRUE)
phi0 = imputation_result$phi0
phi1 = imputation_result$phi1
sigma2 = imputation_result$sigma2
```

## Imputation of missing values based on Student's t AR(1) model

The imputation function `imputeAR1t()` is developed to impute the missing values in time series based on  Student's t AR(1) model. Instead of the Gaussian AR(1) model, the function `imputeAR1t()` fits the Student's t AR(1) model to time series and impute the missing values. The usage of  `imputeAR1t()` is similar to the usage of `imputeAR1Gaussian()`.

```{r, message = FALSE}
library(imputeFin)
data(ts_AR1_t)
y_missing <- ts_AR1_t$y_missing
imputation_result <- imputeAR1t(y_missing, n_samples = 3, return_estimates = TRUE)
y_imputed1 = imputation_result$y_imputed.1
y_imputed2 = imputation_result$y_imputed.2
y_imputed3 = imputation_result$y_imputed.3
phi0 = imputation_result$phi0
phi1 = imputation_result$phi1
sigma2 = imputation_result$sigma2
nu = imputation_result$nu
plotImputed(y_imputed1, column = 1, type = "ggplot2")
```

# Comparison with other packages
We compare our package with the existing package `imputeTS`. We download the adjusted price of S&P 500 index from 2012-01-01 to 2015-07-08, and compute the log prices. Some log prices are deleted to generate missing values. Then we plot the imputed time series obtained by functions in package `imputeTS` and our function `imputeAR1t()`ï¼Œrespectively.

```{r, message = FALSE}
# download data
library(quantmod)
y_orig <- log(Ad(getSymbols("^GSPC", from = "2012-01-01", to = "2015-07-08", auto.assign = FALSE)))
n <- nrow(y_orig)
miss_pct <- 0.2 # the percentage of missing values
n_miss <- floor(miss_pct*n)
index_miss <- round(n/2) + 1:n_miss
y_missing <- y_orig
y_missing[index_miss] <- NA

# impute using package imputeTS
library("imputeTS")
y_imputed_km = na.kalman(y_missing)
y_imputed_random = na.random(y_missing)
y_imputed_linear = na.interpolation(y_missing, "spline")
index_miss_bis = index_miss
par(mfrow=c(2,2))
{ plot(y_missing, main="orignal")
  lines(y_orig[index_miss_bis], col="red", lwd=2) }
{ plot(y_missing, main="kalman")
  lines(y_imputed_km[index_miss_bis], col="red", lwd=2) }
{ plot(y_missing, main="random")
  lines(y_imputed_random [index_miss_bis], col="red", lwd=2) }
{ plot(y_missing, main="spline")
  lines(y_imputed_linear[index_miss_bis], col="red", lwd=2) }

# impute using our package
library(imputeFin)
imputation_result <- imputeAR1t(y_missing, n_samples = 3)
y_imputed1 = imputation_result$y_imputed.1
y_imputed2 = imputation_result$y_imputed.2
y_imputed3 = imputation_result$y_imputed.3
par(mfrow=c(2,2))
{ plot(y_missing, main="orignal")
  lines(y_orig[index_miss_bis], col="red", lwd=2) }
{ plot(y_missing, main="AR1t")
  lines(y_imputed1[index_miss_bis], col="red", lwd=2) }
{ plot(y_missing, main="AR1t")
  lines(y_imputed2[index_miss_bis], col="red", lwd=2) }
{ plot(y_missing, main="AR1t")
  lines(y_imputed3[index_miss_bis], col="red", lwd=2) }

```

# Parameter Estimation Approaches
The parameter estimation for the AR(1) models with Gaussian and Student's t distributed innovations are based on the maximum likelihood estimation (MLE) given the observed data. Suppose we have a univariate time series $y_{1}$, $y_{2}$,$\ldots$,
$y_{T}$ from the Gaussian AR($1$) model 
$$
\begin{equation}
y_{t}=\varphi_{0}+\varphi_{1}y_{t-1}+\varepsilon_{t},\label{eq:ar(1) model}
\end{equation}
$$
where $\varepsilon_{t}\overset{i.i.d.}{\sim}\mathcal{N}\left(0,\sigma^{2}\right)$.
Some values are missing during the collection, and we denote the missing
values by $\mathbf{y}_{\mathsf{miss}}$. Then MLE problem for the
parameters of the Gaussian AR($1$) model takes the form:

$$
\begin{equation}
\begin{aligned}\mathsf{\underset{\varphi_{0},\varphi_{1},\sigma^{2}}{maximize}} & \thinspace\thinspace\thinspace\log\left(\int\prod_{t=2}^{T}f_{g}\left(y_{t};\varphi_{0}+\varphi_{1}y_{t-1},\sigma^{2}\right)\mathsf{d}\mathbf{y}_{\mathsf{miss}}\right),\end{aligned}
\end{equation}
$$
where $f_{g}\left(\cdot\right)$ denotes the probability density function
(pdf) of a Gaussian distribution. 

For Student's $t$ AR(1) model with $\varepsilon_{t}\overset{i.i.d.}{\sim}t\left(0,\sigma^{2},\nu\right)$,
the MLE problem for the parameters takes the form:
$$
\begin{equation}
\begin{aligned}\mathsf{\underset{\varphi_{0},\varphi_{1},\sigma^{2},\nu>0}{maximize}} & \thinspace\thinspace\thinspace\log\left(\int\prod_{t=2}^{T}f_{t}\left(y_{t};\varphi_{0}+\varphi_{1}y_{t-1},\sigma^{2},\nu\right)\mathsf{d}\mathbf{y}_{\mathsf{miss}}\right),\end{aligned}
\label{eq:problem formulation-2}
\end{equation}
$$
where $f_{t}\left(\cdot\right)$ denotes the probability density function
(pdf) of a Gaussian distribution.

The objective function in the above optimization problems are very complicated, and there are no closed-formed solution for them. Thus, it is necessary to resort to the expectation-maximization (EM) framework to derive efficient iterative algorithms to solve these MLE problems. An EM agorithm has been developed to estimate parameters for the Gaussian case [@LittleRubin2002]. A stochastic version of EM algorithm has been derived to deal with the Student's t case [@LiuKumarPalomar2019].


# References {-}
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent
